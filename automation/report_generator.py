#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# è‡ªåŠ¨åŒ–æŠ¥å‘Šç”Ÿæˆå™¨ - ç”ŸæˆæŠ•èµ„åˆ†æå’Œäº¤æ˜“æŠ¥å‘Š

from datetime import datetime, timedelta, date
from pathlib import Path
from typing import Dict, List, Any

import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns

from utils.logger import TradingLogger
from utils.notification import NotificationManager

# å¯é€‰çš„ç¬¬ä¸‰æ–¹åº“æ”¯æŒ
try:
    import schedule
    SCHEDULE_AVAILABLE = True
except ImportError:
    SCHEDULE_AVAILABLE = False

# å¯é€‰çš„ ReportLab æ”¯æŒ
try:
    REPORTLAB_AVAILABLE = True
except ImportError:
    REPORTLAB_AVAILABLE = False

# ä¸´æ—¶æ•°æ®åº“ç±»ï¼Œç›´åˆ°çœŸæ­£çš„æ•°æ®åº“å®ç°å®Œæˆ
class BacktestDatabase:
    """ä¸´æ—¶å›æµ‹æ•°æ®åº“ç±»"""
    def get_backtest_results(self, **kwargs):  # pylint: disable=unused-argument
        """è¿”å›ç¤ºä¾‹å›æµ‹ç»“æœ"""
        return [
            {
                'strategy_name': 'RSIç­–ç•¥',
                'symbol': 'AAPL',
                'total_return': 0.15,
                'sharpe_ratio': 1.2,
                'max_drawdown': 0.08
            },
            {
                'strategy_name': 'MAç­–ç•¥',
                'symbol': 'MSFT',
                'total_return': 0.12,
                'sharpe_ratio': 1.1,
                'max_drawdown': 0.06
            }
        ]

    def get_trading_history(self, **kwargs):  # pylint: disable=unused-argument
        """è¿”å›ç¤ºä¾‹äº¤æ˜“å†å²"""
        return []

# å¸¸é‡å®šä¹‰
TABLE_SECTION_CLOSE = """
            </table>
        </div>
        """

REPORT_FOOTER = """
        <div class="footer">
            <p>Generated by Automated Trading System</p>
            <p>Data for reference only. Trading involves risks.</p>
        </div>
    </body>
    </html>
    """

SCHEDULE_ERROR_MSG = "scheduleåº“æœªå®‰è£…ï¼Œæ— æ³•è°ƒåº¦æŠ¥å‘Š"
DATA_COLLECTION_ERROR = "æ•°æ®æ”¶é›†å¤±è´¥"
REPORT_GENERATION_ERROR = "æŠ¥å‘Šç”Ÿæˆå¤±è´¥"


class ReportGenerator:
    """æŠ¥å‘Šç”Ÿæˆå™¨åŸºç±»"""

    def __init__(self):
        self.logger = TradingLogger(__name__)
        self.notification_manager = NotificationManager()
        self.db = BacktestDatabase()
        self.report_dir = Path("reports")
        self.report_dir.mkdir(exist_ok=True)

        # è®¾ç½®matplotlibä¸­æ–‡å­—ä½“
        plt.rcParams['font.sans-serif'] = ['SimHei', 'DejaVu Sans']
        plt.rcParams['axes.unicode_minus'] = False

        # è®¾ç½®seabornæ ·å¼
        sns.set_style("whitegrid")
        sns.set_palette("husl")

    def generate_daily_report(self, target_date: date = None) -> str:
        """ç”Ÿæˆæ—¥æŠ¥"""
        if target_date is None:
            target_date = date.today()

        self.logger.log_system_event("ç”Ÿæˆæ—¥æŠ¥", f"æ—¥æœŸ: {target_date}")

        # æ”¶é›†å½“æ—¥æ•°æ®
        daily_data = self._collect_daily_data(target_date)

        # ç”ŸæˆæŠ¥å‘Š
        report_content = self._create_daily_report_content(daily_data, target_date)

        # ä¿å­˜æŠ¥å‘Š
        filename = f"daily_report_{target_date.strftime('%Y%m%d')}.html"
        filepath = self.report_dir / filename

        try:
            with open(filepath, 'w', encoding='utf-8', errors='replace') as f:
                f.write(report_content)
        except UnicodeEncodeError:
            # å¦‚æœUTF-8å¤±è´¥ï¼Œä½¿ç”¨ASCIIç¼–ç å¹¶æ›¿æ¢ç‰¹æ®Šå­—ç¬¦
            with open(filepath, 'w', encoding='ascii', errors='replace') as f:
                f.write(report_content)

        self.logger.log_system_event("æ—¥æŠ¥å·²ç”Ÿæˆ", f"æ–‡ä»¶: {filepath}")

        # å‘é€é€šçŸ¥
        self.notification_manager.send_notification(
            f"ğŸ“Š æ—¥æŠ¥å·²ç”Ÿæˆ\næ—¥æœŸ: {target_date}\næ–‡ä»¶: {filename}",
            f"äº¤æ˜“æ—¥æŠ¥ - {target_date}"
        )

        return str(filepath)

    def generate_weekly_report(self, week_end_date: date = None) -> str:
        """ç”Ÿæˆå‘¨æŠ¥"""
        if week_end_date is None:
            week_end_date = date.today()

        # è®¡ç®—æœ¬å‘¨èµ·å§‹æ—¥æœŸ
        week_start_date = week_end_date - timedelta(days=week_end_date.weekday())

        self.logger.log_system_event("ç”Ÿæˆå‘¨æŠ¥", f"å‘¨æœŸ: {week_start_date} åˆ° {week_end_date}")

        # æ”¶é›†æœ¬å‘¨æ•°æ®
        weekly_data = self._collect_weekly_data(week_start_date, week_end_date)

        # ç”ŸæˆæŠ¥å‘Š
        report_content = self._create_weekly_report_content(weekly_data, week_start_date, week_end_date)

        # ä¿å­˜æŠ¥å‘Š
        filename = f"weekly_report_{week_start_date.strftime('%Y%m%d')}_{week_end_date.strftime('%Y%m%d')}.html"
        filepath = self.report_dir / filename

        try:
            with open(filepath, 'w', encoding='utf-8', errors='replace') as f:
                f.write(report_content)
        except UnicodeEncodeError:
            # å¦‚æœUTF-8å¤±è´¥ï¼Œä½¿ç”¨ASCIIç¼–ç å¹¶æ›¿æ¢ç‰¹æ®Šå­—ç¬¦
            with open(filepath, 'w', encoding='ascii', errors='replace') as f:
                f.write(report_content)

        self.logger.log_system_event("å‘¨æŠ¥å·²ç”Ÿæˆ", f"æ–‡ä»¶: {filepath}")

        # å‘é€é€šçŸ¥
        self.notification_manager.send_notification(
            f"ğŸ“Š å‘¨æŠ¥å·²ç”Ÿæˆ\nå‘¨æœŸ: {week_start_date} åˆ° {week_end_date}\næ–‡ä»¶: {filename}",
            f"äº¤æ˜“å‘¨æŠ¥ - ç¬¬{week_end_date.isocalendar()[1]}å‘¨"
        )

        return str(filepath)

    def generate_monthly_report(self, year: int = None, month: int = None) -> str:
        """ç”ŸæˆæœˆæŠ¥"""
        if year is None:
            year = date.today().year
        if month is None:
            month = date.today().month

        # è®¡ç®—æœˆä»½èµ·æ­¢æ—¥æœŸ
        month_start = date(year, month, 1)
        if month == 12:
            month_end = date(year + 1, 1, 1) - timedelta(days=1)
        else:
            month_end = date(year, month + 1, 1) - timedelta(days=1)

        self.logger.log_system_event("ç”ŸæˆæœˆæŠ¥", f"æœˆä»½: {year}å¹´{month}æœˆ")

        # æ”¶é›†æœ¬æœˆæ•°æ®
        monthly_data = self._collect_monthly_data(month_start, month_end)

        # ç”ŸæˆæŠ¥å‘Š
        report_content = self._create_monthly_report_content(monthly_data, year, month)

        # ä¿å­˜æŠ¥å‘Š
        filename = f"monthly_report_{year}{month:02d}.html"
        filepath = self.report_dir / filename

        try:
            with open(filepath, 'w', encoding='utf-8', errors='replace') as f:
                f.write(report_content)
        except UnicodeEncodeError:
            # å¦‚æœUTF-8å¤±è´¥ï¼Œä½¿ç”¨ASCIIç¼–ç å¹¶æ›¿æ¢ç‰¹æ®Šå­—ç¬¦
            with open(filepath, 'w', encoding='ascii', errors='replace') as f:
                f.write(report_content)

        self.logger.log_system_event("æœˆæŠ¥å·²ç”Ÿæˆ", f"æ–‡ä»¶: {filepath}")

        # å‘é€é€šçŸ¥
        self.notification_manager.send_notification(
            f"ğŸ“Š æœˆæŠ¥å·²ç”Ÿæˆ\næœˆä»½: {year}å¹´{month}æœˆ\næ–‡ä»¶: {filename}",
            f"äº¤æ˜“æœˆæŠ¥ - {year}å¹´{month}æœˆ"
        )

        return str(filepath)

    def _collect_daily_data(self, target_date: date) -> Dict[str, Any]:
        """æ”¶é›†æ—¥æŠ¥æ•°æ®"""
        data = {
            'date': target_date,
            'strategies_run': 0,
            'total_signals': 0,
            'profitable_trades': 0,
            'total_trades': 0,
            'best_strategy': None,
            'market_summary': {},
            'signals': [],
            'backtest_results': []
        }

        try:
            # ä»æ•°æ®åº“è·å–å½“æ—¥å›æµ‹ç»“æœ
            start_datetime = datetime.combine(target_date, datetime.min.time())
            end_datetime = datetime.combine(target_date, datetime.max.time())

            results = self.db.get_backtest_results(
                start_date=start_datetime,
                end_date=end_datetime
            )

            if results:
                data['backtest_results'] = results
                data['strategies_run'] = len(results)

                # è®¡ç®—æœ€ä½³ç­–ç•¥
                best_result = max(results, key=lambda x: x.get('total_return', 0))
                data['best_strategy'] = {
                    'name': best_result.get('strategy_name', 'Unknown'),
                    'return': best_result.get('total_return', 0),
                    'symbol': best_result.get('symbol', 'Unknown')
                }

            # æ¨¡æ‹Ÿå¸‚åœºæ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»å®æ—¶æ•°æ®æºè·å–ï¼‰
            data['market_summary'] = self._get_market_summary()

        except (ImportError, FileNotFoundError, ValueError) as e:
            self.logger.log_error(DATA_COLLECTION_ERROR, f"æ”¶é›†æ—¥æŠ¥æ•°æ®å¤±è´¥: {e}")

        return data

    def _collect_weekly_data(self, start_date: date, end_date: date) -> Dict[str, Any]:
        """æ”¶é›†å‘¨æŠ¥æ•°æ®"""
        data = {
            'start_date': start_date,
            'end_date': end_date,
            'total_strategies_run': 0,
            'total_signals': 0,
            'weekly_performance': {},
            'strategy_comparison': [],
            'market_trends': {},
            'backtest_results': []
        }

        try:
            # è·å–å‘¨æœŸå†…çš„å›æµ‹ç»“æœ
            start_datetime = datetime.combine(start_date, datetime.min.time())
            end_datetime = datetime.combine(end_date, datetime.max.time())

            results = self.db.get_backtest_results(
                start_date=start_datetime,
                end_date=end_datetime
            )

            if results:
                data['backtest_results'] = results
                data['total_strategies_run'] = len(results)

                # æŒ‰ç­–ç•¥åˆ†ç»„ç»Ÿè®¡
                strategy_stats = {}
                for result in results:
                    strategy_name = result.get('strategy_name', 'Unknown')
                    if strategy_name not in strategy_stats:
                        strategy_stats[strategy_name] = {
                            'count': 0,
                            'avg_return': 0,
                            'best_return': float('-inf'),
                            'worst_return': float('inf'),
                            'total_return': 0
                        }

                    stats = strategy_stats[strategy_name]
                    stats['count'] += 1
                    return_rate = result.get('total_return', 0)
                    stats['total_return'] += return_rate
                    stats['best_return'] = max(stats['best_return'], return_rate)
                    stats['worst_return'] = min(stats['worst_return'], return_rate)

                # è®¡ç®—å¹³å‡æ”¶ç›Š
                for strategy_name, stats in strategy_stats.items():
                    stats['avg_return'] = stats['total_return'] / stats['count']

                data['strategy_comparison'] = strategy_stats

        except (ImportError, FileNotFoundError, ValueError) as e:
            self.logger.log_error(DATA_COLLECTION_ERROR, f"æ”¶é›†å‘¨æŠ¥æ•°æ®å¤±è´¥: {e}")

        return data

    def _collect_monthly_data(self, start_date: date, end_date: date) -> Dict[str, Any]:
        """æ”¶é›†æœˆæŠ¥æ•°æ®"""
        data = {
            'year': start_date.year,
            'month': start_date.month,
            'start_date': start_date,
            'end_date': end_date,
            'monthly_summary': {},
            'strategy_rankings': [],
            'performance_trends': {},
            'risk_analysis': {},
            'backtest_results': []
        }

        try:
            # è·å–æœˆåº¦å›æµ‹ç»“æœ
            start_datetime = datetime.combine(start_date, datetime.min.time())
            end_datetime = datetime.combine(end_date, datetime.max.time())

            results = self.db.get_backtest_results(
                start_date=start_datetime,
                end_date=end_datetime
            )

            if results:
                data['backtest_results'] = results
                data['monthly_summary'] = self._calculate_monthly_summary(results)
                data['strategy_rankings'] = self._calculate_strategy_rankings(results)

        except (ImportError, FileNotFoundError, ValueError) as e:
            self.logger.log_error(DATA_COLLECTION_ERROR, f"æ”¶é›†æœˆæŠ¥æ•°æ®å¤±è´¥: {e}")

        return data

    def _calculate_monthly_summary(self, results: List[Dict[str, Any]]) -> Dict[str, Any]:
        """è®¡ç®—æœˆåº¦æ‘˜è¦ç»Ÿè®¡"""
        total_returns = [r.get('total_return', 0) for r in results]
        sharpe_ratios = [r.get('sharpe_ratio', 0) for r in results]
        max_drawdowns = [r.get('max_drawdown', 0) for r in results]

        return {
            'total_backtests': len(results),
            'avg_return': np.mean(total_returns) if total_returns else 0,
            'best_return': max(total_returns) if total_returns else 0,
            'worst_return': min(total_returns) if total_returns else 0,
            'avg_sharpe': np.mean(sharpe_ratios) if sharpe_ratios else 0,
            'avg_drawdown': np.mean(max_drawdowns) if max_drawdowns else 0,
            'success_rate': len([r for r in total_returns if r > 0]) / len(total_returns) if total_returns else 0
        }

    def _calculate_strategy_rankings(self, results: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """è®¡ç®—ç­–ç•¥æ’å"""
        strategy_performance = {}
        for result in results:
            strategy = result.get('strategy_name', 'Unknown')
            if strategy not in strategy_performance:
                strategy_performance[strategy] = []
            strategy_performance[strategy].append(result.get('total_return', 0))

        rankings = []
        for strategy, returns in strategy_performance.items():
            rankings.append({
                'strategy': strategy,
                'avg_return': np.mean(returns),
                'count': len(returns),
                'success_rate': len([r for r in returns if r > 0]) / len(returns)
            })

        return sorted(rankings, key=lambda x: x['avg_return'], reverse=True)

    def _get_market_summary(self) -> Dict[str, Any]:
        """è·å–å¸‚åœºæ‘˜è¦æ•°æ®"""
        # æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”ç”¨ä¸­åº”è¿æ¥çœŸå®å¸‚åœºæ•°æ®æº
        return {
            'major_indices': {
                'S&P 500': {'value': 4500, 'change': 0.5},
                'NASDAQ': {'value': 15000, 'change': -0.2},
                'DOW': {'value': 35000, 'change': 0.8}
            },
            'market_mood': 'neutral',
            'volatility': 'low'
        }

    def _create_daily_report_content(self, data: Dict[str, Any], target_date: date) -> str:
        """åˆ›å»ºæ—¥æŠ¥HTMLå†…å®¹"""
        # å°†ä¸­æ–‡æ—¥æœŸè½¬æ¢ä¸ºè‹±æ–‡æ ¼å¼é¿å…ç¼–ç é—®é¢˜
        date_str = target_date.strftime('%Y-%m-%d')
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        html_content = f"""
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Daily Trading Report - {date_str}</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }}
                .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }}
                .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }}
                .metric {{ background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #007bff; }}
                .metric-value {{ font-size: 24px; font-weight: bold; color: #007bff; }}
                .metric-label {{ font-size: 14px; color: #666; margin-top: 5px; }}
                .section {{ margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                .section h3 {{ color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }}
                table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
                th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }}
                th {{ background-color: #f8f9fa; font-weight: bold; }}
                .positive {{ color: #28a745; }}
                .negative {{ color: #dc3545; }}
                .footer {{ text-align: center; color: #666; margin-top: 30px; font-size: 12px; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Daily Trading Report</h1>
                <h2>{date_str}</h2>
                <p>Generated: {current_time}</p>
            </div>

            <div class="summary">
                <div class="metric">
                    <div class="metric-value">{data['strategies_run']}</div>
                    <div class="metric-label">Strategies Run</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{data['total_signals']}</div>
                    <div class="metric-label">Total Signals</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{data['total_trades']}</div>
                    <div class="metric-label">Executed Trades</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{data['profitable_trades']}</div>
                    <div class="metric-label">Profitable Trades</div>
                </div>
            </div>
        """

        # æœ€ä½³ç­–ç•¥éƒ¨åˆ†
        if data['best_strategy']:
            best = data['best_strategy']
            html_content += f"""
            <div class="section">
                <h3>Best Strategy Today</h3>
                <p><strong>Strategy:</strong> {best['name']}</p>
                <p><strong>Symbol:</strong> {best['symbol']}</p>
                <p><strong>Return:</strong> <span class="{'positive' if best['return'] > 0 else 'negative'}">{best['return']:.2%}</span></p>
            </div>
            """

        # å¸‚åœºæ‘˜è¦
        market = data['market_summary']
        html_content += """
        <div class="section">
            <h3>Market Summary</h3>
            <table>
                <tr><th>Index</th><th>Value</th><th>Change</th></tr>
        """

        for index, info in market.get('major_indices', {}).items():
            # æå–åµŒå¥—æ¡ä»¶è¡¨è¾¾å¼
            if info['change'] > 0:
                change_class = 'positive'
            elif info['change'] < 0:
                change_class = 'negative'
            else:
                change_class = ''

            html_content += f"""
                <tr>
                    <td>{index}</td>
                    <td>{info['value']}</td>
                    <td class="{change_class}">{info['change']:+.1f}%</td>
                </tr>
            """

        html_content += TABLE_SECTION_CLOSE

        # å›æµ‹ç»“æœ
        if data['backtest_results']:
            html_content += """
            <div class="section">
                <h3>Backtest Results</h3>
                <table>
                    <tr><th>Strategy</th><th>Symbol</th><th>Return</th><th>Sharpe Ratio</th><th>Max Drawdown</th></tr>
            """

            for result in data['backtest_results']:
                return_class = 'positive' if result.get('total_return', 0) > 0 else 'negative'
                html_content += f"""
                    <tr>
                        <td>{result.get('strategy_name', 'Unknown')}</td>
                        <td>{result.get('symbol', 'Unknown')}</td>
                        <td class="{return_class}">{result.get('total_return', 0):.2%}</td>
                        <td>{result.get('sharpe_ratio', 0):.3f}</td>
                        <td>{result.get('max_drawdown', 0):.2%}</td>
                    </tr>
                """

            html_content += TABLE_SECTION_CLOSE

        # ç»“å°¾
        html_content += REPORT_FOOTER

        return html_content

    def _create_weekly_report_content(self, data: Dict[str, Any], start_date: date, end_date: date) -> str:
        """åˆ›å»ºå‘¨æŠ¥HTMLå†…å®¹"""
        week_num = end_date.isocalendar()[1]

        html_content = f"""
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>äº¤æ˜“å‘¨æŠ¥ - ç¬¬{week_num}å‘¨</title>
            <style>
                body {{ font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; line-height: 1.6; }}
                .header {{ background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }}
                .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }}
                .metric {{ background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #11998e; }}
                .metric-value {{ font-size: 24px; font-weight: bold; color: #11998e; }}
                .metric-label {{ font-size: 14px; color: #666; margin-top: 5px; }}
                .section {{ margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                .section h3 {{ color: #333; border-bottom: 2px solid #11998e; padding-bottom: 10px; }}
                table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
                th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }}
                th {{ background-color: #f8f9fa; font-weight: bold; }}
                .positive {{ color: #28a745; }}
                .negative {{ color: #dc3545; }}
                .footer {{ text-align: center; color: #666; margin-top: 30px; font-size: 12px; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ“Š é‡åŒ–äº¤æ˜“å‘¨æŠ¥</h1>
                <h2>{start_date.year}å¹´ç¬¬{week_num}å‘¨</h2>
                <p>{start_date.strftime('%Y-%m-%d')} è‡³ {end_date.strftime('%Y-%m-%d')}</p>
                <p>ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
            </div>

            <div class="summary">
                <div class="metric">
                    <div class="metric-value">{data['total_strategies_run']}</div>
                    <div class="metric-label">ç­–ç•¥è¿è¡Œæ€»æ¬¡æ•°</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{len(data['strategy_comparison'])}</div>
                    <div class="metric-label">æ´»è·ƒç­–ç•¥æ•°</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{data['total_signals']}</div>
                    <div class="metric-label">äº¤æ˜“ä¿¡å·æ€»æ•°</div>
                </div>
            </div>
        """

        # ç­–ç•¥æ¯”è¾ƒ
        if data['strategy_comparison']:
            html_content += """
            <div class="section">
                <h3>ğŸ“Š ç­–ç•¥è¡¨ç°å¯¹æ¯”</h3>
                <table>
                    <tr><th>ç­–ç•¥åç§°</th><th>è¿è¡Œæ¬¡æ•°</th><th>å¹³å‡æ”¶ç›Šç‡</th><th>æœ€ä½³æ”¶ç›Š</th><th>æœ€å·®æ”¶ç›Š</th></tr>
            """

            for strategy, stats in data['strategy_comparison'].items():
                avg_class = 'positive' if stats['avg_return'] > 0 else 'negative'
                best_class = 'positive' if stats['best_return'] > 0 else 'negative'
                worst_class = 'positive' if stats['worst_return'] > 0 else 'negative'

                html_content += f"""
                    <tr>
                        <td>{strategy}</td>
                        <td>{stats['count']}</td>
                        <td class="{avg_class}">{stats['avg_return']:.2%}</td>
                        <td class="{best_class}">{stats['best_return']:.2%}</td>
                        <td class="{worst_class}">{stats['worst_return']:.2%}</td>
                    </tr>
                """

            html_content += TABLE_SECTION_CLOSE

        # ç»“å°¾
        html_content += REPORT_FOOTER

        return html_content

    def _create_monthly_report_content(self, data: Dict[str, Any], year: int, month: int) -> str:
        """åˆ›å»ºæœˆæŠ¥HTMLå†…å®¹"""
        summary = data['monthly_summary']

        html_content = f"""
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>äº¤æ˜“æœˆæŠ¥ - {year}å¹´{month}æœˆ</title>
            <style>
                body {{ font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; line-height: 1.6; }}
                .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }}
                .summary {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; }}
                .metric {{ background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #667eea; }}
                .metric-value {{ font-size: 20px; font-weight: bold; color: #667eea; }}
                .metric-label {{ font-size: 12px; color: #666; margin-top: 5px; }}
                .section {{ margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                .section h3 {{ color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }}
                table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
                th, td {{ padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }}
                th {{ background-color: #f8f9fa; font-weight: bold; }}
                .positive {{ color: #28a745; }}
                .negative {{ color: #dc3545; }}
                .footer {{ text-align: center; color: #666; margin-top: 30px; font-size: 12px; }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ“Š é‡åŒ–äº¤æ˜“æœˆæŠ¥</h1>
                <h2>{year}å¹´{month}æœˆ</h2>
                <p>ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
            </div>

            <div class="summary">
                <div class="metric">
                    <div class="metric-value">{summary.get('total_backtests', 0)}</div>
                    <div class="metric-label">å›æµ‹æ€»æ¬¡æ•°</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{summary.get('avg_return', 0):.2%}</div>
                    <div class="metric-label">å¹³å‡æ”¶ç›Šç‡</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{summary.get('best_return', 0):.2%}</div>
                    <div class="metric-label">æœ€ä½³æ”¶ç›Šç‡</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{summary.get('avg_sharpe', 0):.3f}</div>
                    <div class="metric-label">å¹³å‡å¤æ™®æ¯”ç‡</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{summary.get('success_rate', 0):.1%}</div>
                    <div class="metric-label">æˆåŠŸç‡</div>
                </div>
                <div class="metric">
                    <div class="metric-value">{summary.get('avg_drawdown', 0):.2%}</div>
                    <div class="metric-label">å¹³å‡æœ€å¤§å›æ’¤</div>
                </div>
            </div>
        """

        # ç­–ç•¥æ’å
        if data['strategy_rankings']:
            html_content += """
            <div class="section">
                <h3>ğŸ† ç­–ç•¥æ’å (æŒ‰å¹³å‡æ”¶ç›Šç‡)</h3>
                <table>
                    <tr><th>æ’å</th><th>ç­–ç•¥åç§°</th><th>å¹³å‡æ”¶ç›Šç‡</th><th>è¿è¡Œæ¬¡æ•°</th><th>æˆåŠŸç‡</th></tr>
            """

            for i, ranking in enumerate(data['strategy_rankings'], 1):
                return_class = 'positive' if ranking['avg_return'] > 0 else 'negative'

                html_content += f"""
                    <tr>
                        <td>{i}</td>
                        <td>{ranking['strategy']}</td>
                        <td class="{return_class}">{ranking['avg_return']:.2%}</td>
                        <td>{ranking['count']}</td>
                        <td>{ranking['success_rate']:.1%}</td>
                    </tr>
                """

            html_content += """
                </table>
            </div>
            """

        # ç»“å°¾
        html_content += REPORT_FOOTER

        return html_content


class AutoReportScheduler:
    """è‡ªåŠ¨æŠ¥å‘Šè°ƒåº¦å™¨"""

    def __init__(self):
        self.report_generator = ReportGenerator()
        self.logger = TradingLogger(__name__)

    def schedule_daily_reports(self, time_str: str = "18:00"):
        """è°ƒåº¦æ—¥æŠ¥ç”Ÿæˆ"""
        if not SCHEDULE_AVAILABLE:
            self.logger.log_error("ä¾èµ–ç¼ºå¤±", SCHEDULE_ERROR_MSG)
            return

        schedule.every().day.at(time_str).do(self._generate_daily_report)
        self.logger.log_system_event("è°ƒåº¦æ—¥æŠ¥", f"æ¯æ—¥ {time_str}")

    def schedule_weekly_reports(self, day: str = "monday", time_str: str = "09:00"):
        """è°ƒåº¦å‘¨æŠ¥ç”Ÿæˆ"""
        if not SCHEDULE_AVAILABLE:
            self.logger.log_error("ä¾èµ–ç¼ºå¤±", SCHEDULE_ERROR_MSG)
            return

        getattr(schedule.every(), day.lower()).at(time_str).do(self._generate_weekly_report)
        self.logger.log_system_event("è°ƒåº¦å‘¨æŠ¥", f"æ¯å‘¨{day} {time_str}")

    def schedule_monthly_reports(self, day: int = 1, time_str: str = "09:00"):
        """è°ƒåº¦æœˆæŠ¥ç”Ÿæˆ"""
        if not SCHEDULE_AVAILABLE:
            self.logger.log_error("ä¾èµ–ç¼ºå¤±", SCHEDULE_ERROR_MSG)
            return

        # schedule åº“ä¸æ”¯æŒæœˆåº¦è°ƒåº¦ï¼Œè¿™é‡Œä½¿ç”¨æ—¥è°ƒåº¦ä½œä¸ºæ›¿ä»£
        schedule.every().day.at(time_str).do(self._generate_monthly_report)
        self.logger.log_system_event("è°ƒåº¦æœˆæŠ¥", f"æ¯æœˆ{day}æ—¥ {time_str}")

    def _generate_daily_report(self):
        """ç”Ÿæˆæ—¥æŠ¥çš„åŒ…è£…å‡½æ•°"""
        try:
            self.report_generator.generate_daily_report()
        except (ImportError, FileNotFoundError, ValueError) as e:
            self.logger.log_error(REPORT_GENERATION_ERROR, f"æ—¥æŠ¥ç”Ÿæˆå¤±è´¥: {e}")

    def _generate_monthly_report(self):
        """ç”ŸæˆæœˆæŠ¥çš„åŒ…è£…å‡½æ•°"""
        try:
            self.report_generator.generate_monthly_report()
        except (ImportError, FileNotFoundError, ValueError) as e:
            self.logger.log_error(REPORT_GENERATION_ERROR, f"æœˆæŠ¥ç”Ÿæˆå¤±è´¥: {e}")

    def _generate_weekly_report(self):
        """ç”Ÿæˆå‘¨æŠ¥çš„åŒ…è£…å‡½æ•°"""
        try:
            self.report_generator.generate_weekly_report()
        except (ImportError, FileNotFoundError, ValueError) as e:
            self.logger.log_error(REPORT_GENERATION_ERROR, f"å‘¨æŠ¥ç”Ÿæˆå¤±è´¥: {e}")

    def _check_monthly_report(self):
        """æ£€æŸ¥æ˜¯å¦éœ€è¦ç”ŸæˆæœˆæŠ¥"""
        today = date.today()
        if today.day == 1:  # æ¯æœˆ1æ—¥ç”Ÿæˆä¸ŠæœˆæŠ¥å‘Š
            try:
                last_month = today.replace(day=1) - timedelta(days=1)
                self.report_generator.generate_monthly_report(
                    last_month.year,
                    last_month.month
                )
            except (ImportError, FileNotFoundError, ValueError) as e:
                self.logger.log_error(REPORT_GENERATION_ERROR, f"æœˆæŠ¥ç”Ÿæˆå¤±è´¥: {e}")


# ç¤ºä¾‹ç”¨æ³•
if __name__ == "__main__":
    # åˆ›å»ºæŠ¥å‘Šç”Ÿæˆå™¨
    generator = ReportGenerator()

    # ç”Ÿæˆä»Šæ—¥æŠ¥å‘Š
    DAILY_REPORT = generator.generate_daily_report()
    print(f"æ—¥æŠ¥å·²ç”Ÿæˆ: {DAILY_REPORT}")

    # ç”Ÿæˆæœ¬å‘¨æŠ¥å‘Š
    WEEKLY_REPORT = generator.generate_weekly_report()
    print(f"å‘¨æŠ¥å·²ç”Ÿæˆ: {WEEKLY_REPORT}")

    # ç”Ÿæˆæœ¬æœˆæŠ¥å‘Š
    MONTHLY_REPORT = generator.generate_monthly_report()
    print(f"æœˆæŠ¥å·²ç”Ÿæˆ: {MONTHLY_REPORT}")
